# План разработки RAG-системы на базе SmartChanker

## Обзор проекта

RAG-система для работы с документами, использующая интеллектуальный чанкер SmartChanker для создания структурированных чанков с сохранением иерархической структуры документов.

## Технологический стек

- **Чанкер**: SmartChanker (https://github.com/igorvolk1961/smart_chanker)
- **RAG Framework**: LlamaIndex
- **Векторное хранилище**: Qdrant
  - Executable: `f:/programs/qdrant/qdrant.exe`
  - Config: `f:/programs/qdrant/qdrant_config.yaml`
- **Эмбеддинги**: Ollama API
  - Model: `jeffh/intfloat-multilingual-e5-large:q8_0`
  - API URL: `http://localhost:11434/v1`
  - Batch size: 8
  - Max retries: 3
  - Timeout: 60s
- **Backend**: FastAPI
- **Desktop App**: Для отладки и тестирования

## Этапы разработки

### Этап 1: Настройка окружения и интеграция чанкера

**Цель**: Подготовить проект и интегрировать SmartChanker

**Задачи**:
1. Создать структуру проекта
2. Настроить зависимости (requirements.txt)
3. Интегрировать SmartChanker (выбрать способ установки)
4. Создать конфигурационные файлы:
   - `config.yaml` - общая конфигурация RAG-системы
   - `qdrant_config.yaml` - конфигурация Qdrant (если нужна)
   - `.env` - переменные окружения
5. Создать базовую структуру модулей:
   - `rag/` - основной модуль RAG
   - `api/` - FastAPI приложение
   - `desktop/` - десктоп-приложение
   - `utils/` - утилиты

**Результат**: Рабочее окружение с интегрированным чанкером

---

### Этап 2: Базовая интеграция LlamaIndex и Qdrant

**Цель**: Настроить базовую RAG-цепочку с векторным поиском

**Задачи**:
1. Создать кастомный эмбеддинг-класс для Ollama:
   - Интеграция с Ollama API
   - Поддержка батчинга (batch_size=8)
   - Обработка ошибок и retry логика
   - Таймауты
2. Настроить подключение к Qdrant:
   - Использование локального Qdrant
   - Создание коллекций
   - Настройка индексов
3. Создать базовый пайплайн индексации:
   - Загрузка документов через SmartChanker
   - Извлечение чанков с метаданными
   - Генерация эмбеддингов
   - Сохранение в Qdrant с метаданными
4. Создать базовый пайплайн поиска:
   - Векторный поиск по запросу
   - Извлечение топ-K результатов
   - Формирование контекста

**Результат**: Работающая базовая RAG-система с векторным поиском

---

### Этап 3: Использование метаданных чанков для улучшения контекста

**Цель**: Использовать иерархическую структуру чанков для улучшения качества контекста

**Задачи**:
1. Анализ структуры метаданных SmartChanker:
   - Иерархические уровни (1., 1.1., 1.1.1.)
   - Родительские разделы
   - Информация об оглавлении
   - Позиции в документе
2. Реализация стратегий расширения контекста:
   - **Родительские разделы**: Добавление родительских разделов к найденным чанкам
   - **Соседние чанки**: Добавление соседних чанков того же уровня
   - **Заголовки разделов**: Добавление заголовков для контекста
   - **Оглавление**: Использование TOC для понимания структуры
3. Создание метаданных-фильтров:
   - Фильтрация по уровням иерархии
   - Фильтрация по типам контента (текст, таблицы, списки)
   - Фильтрация по позиции в документе
4. Оптимизация размера контекста:
   - Приоритизация чанков
   - Умное объединение контента
   - Ограничение по токенам

**Результат**: RAG-система, использующая метаданные для формирования улучшенного контекста

---

### Этап 4: FastAPI сервис

**Цель**: Создать REST API для RAG-системы

**Задачи**:
1. Создать основные эндпоинты:
   - `POST /documents/upload` - загрузка и индексация документов
   - `POST /documents/index` - индексация существующих документов
   - `POST /query` - поиск и генерация ответа
   - `GET /documents` - список документов
   - `DELETE /documents/{doc_id}` - удаление документа
   - `GET /health` - проверка здоровья сервиса
2. Реализовать схемы данных (Pydantic):
   - Модели запросов и ответов
   - Валидация входных данных
3. Обработка ошибок:
   - Кастомные исключения
   - HTTP статус-коды
   - Детальные сообщения об ошибках
4. Логирование и мониторинг:
   - Структурированное логирование
   - Метрики производительности
5. Документация API:
   - Swagger/OpenAPI
   - Примеры запросов

**Результат**: Рабочий FastAPI сервис с полным набором эндпоинтов

---

### Этап 5: Десктоп-приложение для отладки

**Цель**: Создать удобный интерфейс для тестирования и отладки

**Задачи**:
1. Выбор фреймворка для десктоп-приложения:
   - Варианты: Tkinter, PyQt5/PyQt6, Electron+Python, или другой
2. Основной функционал:
   - Загрузка документов
   - Просмотр индексированных документов
   - Поиск и отображение результатов
   - Визуализация метаданных чанков
   - Отображение иерархической структуры
   - Настройка параметров поиска
3. Отладочные инструменты:
   - Просмотр эмбеддингов (если возможно)
   - Анализ метаданных найденных чанков
   - Логи запросов
   - Метрики производительности

**Результат**: Десктоп-приложение для удобной отладки RAG-системы

---

### Этап 6: Оптимизация и улучшения

**Цель**: Улучшить качество и производительность системы

**Задачи**:
1. Оптимизация эмбеддингов:
   - Кэширование эмбеддингов
   - Оптимизация батчинга
   - Параллельная обработка
2. Улучшение качества поиска:
   - Настройка параметров Qdrant (distance, HNSW)
   - Эксперименты с размером чанков
   - A/B тестирование стратегий расширения контекста
3. Производительность:
   - Асинхронная обработка
   - Оптимизация запросов к Qdrant
   - Индексация больших объемов данных

**Результат**: Оптимизированная и производительная RAG-система

---

### Этап 7: Полнотекстовый поиск (будущий этап)

**Цель**: Добавить гибридный поиск (векторный + полнотекстовый)

**Задачи**:
1. Интеграция полнотекстового поиска:
   - Выбор решения (Elasticsearch, Meilisearch, или встроенный в Qdrant)
   - Индексация текста для полнотекстового поиска
2. Гибридный поиск:
   - Комбинирование результатов векторного и полнотекстового поиска
   - Взвешивание результатов
   - Дедупликация

**Результат**: Гибридный поиск для улучшения точности

---

### Этап 8: Реранкинг (будущий этап)

**Цель**: Добавить реранкинг результатов для повышения точности

**Задачи**:
1. Выбор модели реранкинга:
   - Cross-encoder модели
   - Специализированные модели реранкинга
2. Интеграция реранкинга:
   - Реранкинг кандидатов из векторного поиска
   - Использование метаданных в реранкинге
   - Оптимизация производительности
3. A/B тестирование:
   - Сравнение с базовым векторным поиском
   - Метрики качества

**Результат**: RAG-система с реранкингом для максимальной точности

---

## Структура проекта (предварительная)

```
smart_rag/
├── rag/
│   ├── __init__.py
│   ├── chunker_integration.py    # Интеграция SmartChanker
│   ├── embeddings.py              # Кастомный эмбеддинг для Ollama
│   ├── vector_store.py            # Работа с Qdrant
│   ├── indexer.py                 # Индексация документов
│   ├── retriever.py               # Поиск и извлечение контекста
│   ├── context_builder.py         # Построение контекста с метаданными
│   └── rag_pipeline.py            # Основной RAG пайплайн
├── api/
│   ├── __init__.py
│   ├── main.py                    # FastAPI приложение
│   ├── routes/
│   │   ├── documents.py
│   │   └── query.py
│   ├── models/
│   │   ├── requests.py
│   │   └── responses.py
│   └── exceptions.py
├── desktop/
│   ├── __init__.py
│   ├── main.py                    # Точка входа десктоп-приложения
│   └── ui/                        # UI компоненты
├── utils/
│   ├── __init__.py
│   ├── config.py                  # Загрузка конфигурации
│   └── logging.py                 # Настройка логирования
├── config.yaml                    # Конфигурация RAG-системы
├── .env.example                   # Пример переменных окружения
├── requirements.txt               # Зависимости Python
├── README.md                      # Документация проекта
└── DEVELOPMENT_PLAN.md            # Этот файл
```

## Конфигурация (предварительная структура)

### config.yaml
```yaml
qdrant:
  executable_path: "f:/programs/qdrant/qdrant.exe"
  config_path: "f:/programs/qdrant/qdrant_config.yaml"
  collection_name: "smart_rag_documents"
  vector_size: 1024  # Размер эмбеддинга модели

embeddings:
  model: "jeffh/intfloat-multilingual-e5-large:q8_0"
  api_url: "http://localhost:11434/v1"
  batch_size: 8
  max_retries: 3
  timeout: 60

chunker:
  config_path: "config.json"  # Конфигурация SmartChanker
  output_dir: "data/chunks"

rag:
  top_k: 5                      # Количество чанков для извлечения
  context_expansion:
    enabled: true
    include_parents: true       # Включать родительские разделы
    include_siblings: true      # Включать соседние чанки
    max_context_tokens: 4000    # Максимальный размер контекста

api:
  host: "0.0.0.0"
  port: 8000
  debug: false
```

## Метрики успеха

- **Точность поиска**: Релевантность найденных чанков
- **Качество ответов**: Корректность и полнота ответов на вопросы
- **Производительность**: Скорость индексации и поиска
- **Использование метаданных**: Эффективность расширения контекста

## Примечания

- Разработка ведется поэтапно, каждый этап завершается тестированием
- После каждого этапа возможны корректировки плана
- Фокус на качестве и использовании лучших практик RAG
- Метаданные чанков - ключевой элемент для улучшения качества

